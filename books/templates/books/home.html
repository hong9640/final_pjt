{% extends "base.html" %}
{% load static %}

{% block content %}
  {# 1. 공통 고정 카테고리 네비게이션 바 인클루드 #}
  {% include "books/includes/sticky_category_nav.html" %}

<style>

  .home-page-content-wrapper {
    margin-top: 40px; /* 임시 값, 실제 sticky_category_navbar의 높이로 변경하세요! */
  }

  .home-content-sections-wrapper { /* 검색바, 베스트셀러 등 주요 내용을 감싸는 중앙 정렬 컨테이너 */
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 20px;
  }

  /* 검색바 스타일 (home.html 고유 스타일로 유지) */
  .search-bar {
    display: flex;
    justify-content: center;
    margin: 20px 0; /* 이전 .home-container 내부에서의 margin과 동일하게 유지 */
  }
  .search-bar input { width: 300px; padding: 10px; border-radius: 15px 0 0 15px; border: 1px solid #ccc; }
  .search-bar button { padding: 10px 15px; border: 1px solid #ccc; background-color: #eee; border-radius: 0 15px 15px 0; cursor: pointer; }

  /* 베스트셀러 필터 탭 스타일 (home.html 고유 스타일로 유지) */
  .category-tabs {
    display: flex; gap: 10px; margin: 10px 0; background-color: #52b7b7;
    padding: 10px; border-radius: 8px; flex-wrap: wrap;
  }
  .category-tab {
    background-color: white; color: #52b7b7; border: none; padding: 10px 15px;
    border-radius: 8px; cursor: pointer; font-weight: bold;
  }

  /* 책 목록 관련 스타일 (home.html 고유 스타일로 유지) */
  .bestseller-list, .book-grid {
    display: flex; gap: 20px; flex-wrap: wrap; margin: 20px 0;
  }
  .book-item, .book-card {
    background-color: #eee; padding: 10px; border-radius: 10px;
    width: 150px; text-align: center;
  }
  .book-item img, .book-card img {
    width: 100%; height: auto; border-radius: 5px;
  }

  /* 섹션 나누기 스타일 (home.html 고유 스타일로 유지) */
  .sections {
    display: flex; justify-content: space-between; gap: 20px; margin: 20px 0;
  }
  .section { flex: 1; }
  .review-placeholder { background-color: #eee; height: 200px; border-radius: 10px; padding: 20px; }

</style>

{# 2. 페이지별 콘텐츠는 새로운 wrapper 안에 배치하여 margin-top 적용 #}
<div class="home-page-content-wrapper">
  <div class="home-content-sections-wrapper"> {# 이전의 home-container 역할 #}
    <div class="search-bar">
      <form action="{% url 'books:all_books_list' %}" method="GET" style="display: flex;">
          <input type="text" name="q" placeholder="검색어를 입력하세요">
          <button type="submit">🔍</button>
      </form>
    </div>

    <h2>베스트셀러</h2>
    <div class="bestseller-section">
      <div class="category-tabs">
        {# 이 'categories'는 views.home에서 전달하는 베스트셀러 필터용 카테고리 목록입니다. #}
        {# global_categories (상단 네비용)와 다를 수 있습니다. #}
        {% for category_for_tab in categories %}
          <button class="category-tab" onclick="filterCategory('{{ category_for_tab.id }}')">
            {{ category_for_tab.display_name }} {# 또는 category_for_tab.name #}
          </button>
        {% endfor %}
      </div>

      <div class="bestseller-list" id="bestseller-list">
      {% for book in bestseller_books %}
        <div class="book-item">
          <img src="{{ book.cover_image_url }}" alt="{{ book.title }}">
          <p>{{ book.title }}</p>
          <a href="{% url 'books:book_detail' book_id=book.id %}" class="detail-link">자세히</a>
        </div>
      {% endfor %}
      </div>
    </div>

    <div class="sections">
      <section class="section new-books">
        <h2>신간</h2>
        <div class="book-grid">
          {% for book in new_books %}
            <div class="book-card">
              <img src="{{ book.cover_image_url }}" alt="{{ book.title }}">
              <p>{{ book.title }}</p>
              <a href="{% url 'books:book_detail' book_id=book.id %}" class="detail-link">자세히</a>
            </div>
          {% endfor %}
        </div>
      </section>

      <section class="section reviews">
        <h2>실시간 리뷰</h2>
        <div class="review-placeholder">
          리뷰 내용이 여기에 표시됩니다.
        </div>
      </section>
    </div>
  </div> {# End of home-content-sections-wrapper #}
</div> {# End of home-page-content-wrapper #}

<script>
  const allBooks = [
    {% for book in bestseller_books %}
    {
      id: '{{ book.id }}',
      category_id: '{{ book.category.id }}',
      title: '{{ book.title|escapejs }}',
      cover_image_url: '{{ book.cover_image_url|escapejs }}',
      detail_url: '{% url "books:book_detail" book_id=book.id %}'
    },
    {% endfor %}
  ];

  function filterCategory(categoryId) {
    const listDiv = document.getElementById('bestseller-list');
    listDiv.innerHTML = '';

    let filteredBooks;
    if (categoryId === 'all') { // 'all' 버튼이 있다면, 해당 ID를 사용하거나 별도 처리
      filteredBooks = allBooks;
    } else {
      filteredBooks = allBooks.filter(book => String(book.category_id) === String(categoryId));
    }

    if(filteredBooks.length === 0) {
      listDiv.innerHTML = '<p>해당 카테고리의 베스트셀러가 없습니다.</p>';
      return;
    }

    filteredBooks.forEach(book => {
      const bookDiv = document.createElement('div');
      bookDiv.className = 'book-item';
      bookDiv.innerHTML = `
        <img src="${book.cover_image_url}" alt="${book.title}">
        <p>${book.title}</p>
        <a href="${book.detail_url}" class="detail-link">자세히</a> 
      `;
      listDiv.appendChild(bookDiv);
    });
  }
</script>
{% endblock content %}