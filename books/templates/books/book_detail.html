{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
  /* detail.html 특정 스타일 (기존 스타일 유지) */
  .book-detail-page-container {
    max-width: 900px; margin: 2rem auto; padding: 2rem; background-color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 8px;
  }
  .book-primary-info-section { display: flex; gap: 2rem; margin-bottom: 2.5rem; }
  .book-cover-container { flex: 0 0 220px; height: 330px; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 4px; overflow: hidden; }
  .book-cover-container img { width: 100%; height: 100%; object-fit: cover; }
  .book-meta-details { flex: 1; }
  .book-main-title { font-size: 2.2em; font-weight: bold; color: #333; margin-top: 0; margin-bottom: 0.75rem; }
  .book-info-block, .book-description-block { background-color: #f7f7f7; padding: 1rem 1.5rem; border-radius: 4px; margin-bottom: 1rem; min-height: 60px; font-size: 0.95em; color: #444; }
  .book-description-block { min-height: 100px; }
  .author-info-section { margin-bottom: 2.5rem; padding-top: 2rem; border-top: 1px solid #e5e5e5; }
  .author-info-section h2 { font-size: 1.5em; margin-bottom: 1.5rem; color: #333; }
  .author-layout { display: flex; align-items: center; gap: 1.5rem; }
  .author-image-container { width: 100px; height: 100px; background-color: #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; }
  .author-image-container img { width: 100%; height: 100%; object-fit: cover; }
  .author-profile-block { background-color: #f7f7f7; padding: 1rem 1.5rem; border-radius: 4px; min-height: 80px; flex-grow: 1; font-size: 0.95em; color: #444; }
  .book-purchase-link { display: block; text-align: center; margin: 2rem 0 3rem 0; font-size: 1.2em; font-weight: bold; color: #A67C52; text-decoration: none; padding: 0.75rem; border: 1px solid #D2B9AD; border-radius: 4px; background-color: transparent; transition: background-color 0.3s, color 0.3s; }
  .book-purchase-link:hover { background-color: #D2B9AD; color: #fff; }
  /* ... (리뷰 관련 스타일은 기존과 동일하게 유지) ... */
  .review-main-section { padding-top: 2rem; border-top: 1px solid #e5e5e5; }
  .review-main-section h2 { font-size: 1.5em; margin-bottom: 1.5rem; color: #333; }
  .review-write-container, .review-list-container { margin-bottom: 2rem; }
  .review-form-box { background-color: #fdfdfd; padding: 1.5rem; border: 1px solid #e9e9e9; border-radius: 8px; }
  .review-form-box textarea { width: calc(100% - 2rem); min-height: 100px; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 0.95em; }
  .review-form-box .star-input-area span, .review-item-stars span { font-size: 1.8em; color: #ccc; cursor: pointer; margin-right: 2px; }
  .review-form-box .star-input-area span.filled, .review-item-stars span.filled { color: #f5a623; }
  .review-form-box .form-row { display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-top: 1rem; }
  .review-form-box input[type="text"] { padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; flex-grow: 1; font-size: 0.9em; }
  .review-form-box .review-buttons button { background-color: #D2B9AD; color: #2C1B13; border: none; padding: 0.75rem 1.2rem; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 0.5rem; transition: background-color 0.2s; }
  .review-form-box .review-buttons button:hover { background-color: #A67C52; color: #fff; }
  .review-form-box .review-buttons button.secondary { background-color: #e0e0e0; color: #333; }
  .review-form-box .review-buttons button.secondary:hover { background-color: #c0c0c0; }
  .review-item-card { background-color: #fdfdfd; border: 1px solid #e9e9e9; border-radius: 8px; margin-bottom: 1.5rem; padding: 1.5rem; display: flex; gap: 1.5rem; }
  .review-user-avatar-placeholder { width: 60px; height: 60px; background-color: #e0e0e0; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.8em; color: #777; text-align: center; flex-shrink: 0; }
  .review-details-content { flex-grow: 1; }
  .review-text-block { background-color: #f0f0f0; padding: 1rem; min-height: 60px; margin: 0.5rem 0 1rem 0; border-radius: 4px; font-size: 0.95em; }
  .review-meta-info { font-size: 0.85em; color: #666; margin-bottom: 1rem; }
  .review-meta-info span { margin-right: 1rem; }
  .review-interaction-buttons button { background-color: #f0f0f0; color: #555; border: 1px solid #ddd; padding: 0.5rem 0.8rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem; font-size: 0.85em; }
  .review-interaction-buttons button:hover { background-color: #e0e0e0; }
  .review-comments-placeholder-block { background-color: #f0f0f0; padding: 1rem; min-height: 50px; margin-top: 1rem; border-radius: 4px; color: #777; font-size: 0.9em; }
  .no-reviews-message { text-align: center; color: #777; padding: 2rem; }
  .add-to-library-button-container {
    text-align: center;
    margin: 1.5rem 0;
  }
  .add-to-library-button {
    display: inline-block;
    background-color: #A67C52;
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    text-align: center;
    text-decoration: none;
    font-size: 1em; /* 글자 크기 */
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  .add-to-library-button:hover {
    background-color: #8c6b4a;
  }
  .add-to-library-button-container { text-align: center; margin: 1.5rem 0; }
  .add-to-library-button { display: inline-block; background-color: #A67C52; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px; text-align: center; text-decoration: none; font-size: 1em; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
  .add-to-library-button:hover { background-color: #8c6b4a; }

  /* "내 서재에서 제거" 버튼 스타일 추가 */
  .remove-from-library-button {
    display: inline-block;
    background-color: #d9534f; /* 예시: 빨간색 계열 */
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    text-align: center;
    text-decoration: none;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  .remove-from-library-button:hover {
    background-color: #c9302c; /* 호버 시 약간 어둡게 */
  }
  .star-rating-hidden-input { display: none; }
  .review-user-avatar-placeholder img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
  .form-field-errors { color: red; font-size: 0.8em; list-style-type: none; padding-left: 0; margin-top: 2px; }
</style>

<div class="book-detail-page-container">
  <section class="book-primary-info-section">
    <div class="book-cover-container">
      {% if book.cover_image_url %}
        <img src="{{ book.cover_image_url }}" alt="{{ book.title }} 표지">
      {% else %}
        책 사진
      {% endif %}
    </div>
    <div class="book-meta-details">
      <h1 class="book-main-title">{{ book.title }}</h1>
      <div class="book-info-block">
        <p><strong>저자:</strong> {{ book.author.name|default:"정보 없음" }}</p>
        <p><strong>출판사:</strong> {{ book.publisher|default:"정보 없음" }}</p>
        <p><strong>출간일:</strong> {{ book.pub_date|default:"정보 없음" }}</p>
      </div>
      <div class="book-description-block">
        {{ book.description|linebreaksbr|default:"책 설명이 여기에 표시됩니다." }}
      </div>
    </div>
  </section>

  {% if user.is_authenticated %}
  <div class="add-to-library-button-container">
    {% if is_in_library %}
      <form method="POST" action="{% url 'libraries:remove_from_library_to_detail' book_id=book.id %}">
        {% csrf_token %}
        <button type="submit" class="remove-from-library-button">내 서재에서 제거</button>
      </form>
    {% else %}
      <form method="POST" action="{% url 'libraries:add_to_library' book_id=book.id %}">
        {% csrf_token %}
        <button type="submit" class="add-to-library-button">내 서재에 추가</button>
      </form>
    {% endif %}
  </div>
  {% endif %}

  <section class="author-info-section">
    <h2>{{ clean_author_name }}</h2>
    <div class="author-layout">
      <div class="author-image-container">
        {% if book.author and book.author.profile_image %}
          <img src="{{ book.author.profile_image }}" alt="{{ book.author.name }}">
        {% else %}
          <img src="{% static 'images/author_default_img.png' %}" alt="기본 작가 이미지">
        {% endif %}
      </div>
      <div class="author-profile-block">
        {% if book.author and book.author.biography %}
          {{ book.author.biography|linebreaksbr }}
        {% else %}
          작가 정보를 준비 중입니다.
        {% endif %}
      </div>
    </div>
  </section>

  <a href="{{ book.link|default:'#' }}" class="book-purchase-link" target="_blank">
    책 보러 가기 (알라딘 링크)
  </a>

  <section class="review-main-section">
    <div class="review-write-container">
      <h2>리뷰 쓰기</h2>
      {% if user.is_authenticated %}
        <form method="POST" action="{% url 'reviews:add_review' book_id=book.id %}" class="review-form-box">
          {% csrf_token %}
          <div class="star-input-area" id="writeStarRating">
            <span data-value="1">☆</span><span data-value="2">☆</span><span data-value="3">☆</span><span data-value="4">☆</span><span data-value="5">☆</span>
          </div>
          {{ review_form.rating }}
          <div>
            {{ review_form.content.label_tag }}<br>
            {{ review_form.content }}
          </div>
          <div class="form-row">
            <div style="flex-grow: 1;"></div>
            <div class="review-buttons">
              <button type="submit">리뷰 등록</button>
            </div>
          </div>
        </form>
      {% else %}
        <p><a href="{% url 'accounts:login' %}?next={{ request.path }}">로그인</a> 후 리뷰를 작성할 수 있습니다.</p>
      {% endif %}
    </div>

    <div class="review-list-container">
      <h2>리뷰 ({{ reviews.count }})</h2>
      {% if reviews %}
        {% for review in reviews %}
        <div class="review-item-card">
          <div class="review-user-avatar-placeholder">
            {% if review.user.profile_image %}
              <img src="{{ review.user.profile_image.url }}" alt="{{ review.user.username }}">
            {% else %}
              {{ review.user.username|slice:":1"|upper }}
            {% endif %}
          </div>
          <div class="review-details-content">
            <div class="review-item-stars">
              {% for i_star in "12345" %}
                <span class="{% if i_star|add:0 <= review.rating %}filled{% endif %}">
                  {% if i_star|add:0 <= review.rating %}★{% else %}☆{% endif %}
                </span>
              {% endfor %}
            </div>
            <div class="review-text-block">
              {{ review.content|linebreaksbr }}
            </div>
            <div class="review-meta-info">
              <span>작성자: {{ review.user.username }}</span>
              <span>작성시간: {{ review.created_at|date:"Y.m.d H:i" }}</span>
              {% if review.book_category_at_review %}
                <span>카테고리: {{ review.book_category_at_review }}</span>
              {% endif %}
            </div>
            <div class="review-interaction-buttons">
              <button type="button" onclick="alert('댓글 기능은 준비 중입니다.');">댓글 달기</button>
              <button type="button" onclick="alert('좋아요 기능은 준비 중입니다.');">좋아요</button>
            </div>
            <div class="review-comments-placeholder-block">댓글 영역 (준비 중)</div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="no-reviews-message">아직 등록된 리뷰가 없습니다. 첫 번째 리뷰를 작성해주세요!</p>
      {% endif %}
    </div>
  </section>
</div>

<script>
  const starRatingContainer = document.getElementById('writeStarRating');
  const ratingHiddenInput = document.querySelector('input[name="rating"]#id_rating_hidden');

  if (starRatingContainer && ratingHiddenInput) {
    const stars = Array.from(starRatingContainer.querySelectorAll('span'));
    let currentRating = parseInt(ratingHiddenInput.value) || 0;

    function setStarsDisplay(rating) {
      stars.forEach((star, index) => {
        if (index < rating) {
          star.innerHTML = '★';
          star.classList.add('filled');
        } else {
          star.innerHTML = '☆';
          star.classList.remove('filled');
        }
      });
    }

    setStarsDisplay(currentRating);

    stars.forEach(star => {
      const starValue = parseInt(star.getAttribute('data-value'));
      star.addEventListener('click', () => {
        currentRating = starValue;
        ratingHiddenInput.value = currentRating;
        setStarsDisplay(currentRating);
      });
      star.addEventListener('mouseover', () => {
        const hoverRating = parseInt(star.getAttribute('data-value'));
        stars.forEach((s, i) => {
          s.innerHTML = i < hoverRating ? '★' : '☆';
        });
      });
      star.addEventListener('mouseout', () => {
        setStarsDisplay(currentRating);
      });
    });
  }
</script>
{% endblock %}