{% extends "base.html" %}
{% load static %} {# ë§Œì•½ custom_filters ë“± ë‹¤ë¥¸ íƒœê·¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ì—¬ê¸°ì— í•¨ê»˜ load í•©ë‹ˆë‹¤. ì˜ˆ: {% load static custom_filters %} #}
{% block content %}
{% include "books/includes/sticky_category_nav.html" %}

<style>
    /* ê¸°ì¡´ .category-page-content-wrapper, .category-sections-wrapper ë“± ìŠ¤íƒ€ì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ */
    .category-page-content-wrapper {
        /* margin-top: 20px; */
    }
    .category-sections-wrapper {
        max-width: 1100px;
        margin: 0 auto;
        padding: 20px;
        /* background-color: #f8f5f0; */
    }

    /* === ê²€ìƒ‰ì°½ ë° ë“œë¡­ë‹¤ìš´ì„ ìœ„í•œ CSS (ì´ ë¶€ë¶„ì„ í™•ì¸ ë° ì¶”ê°€/ìˆ˜ì •) === */
    .search-bar {
        display: flex;            /* ë‚´ë¶€ ìš”ì†Œë“¤ì„ ê°€ë¡œë¡œ ë°°ì¹˜ */
        justify-content: center;  /* ì¤‘ì•™ ì •ë ¬ */
        margin-bottom: 30px;      /* ê¸°ì¡´ ê°„ê²© ìœ ì§€ */
        align-items: stretch;     /* ë“œë¡­ë‹¤ìš´ ë²„íŠ¼, ì…ë ¥ì°½, ê²€ìƒ‰ë²„íŠ¼ì˜ ë†’ì´ë¥¼ ë™ì¼í•˜ê²Œ ë§ì¶¤ */
    }

    .search-type-dropdown {
        position: relative;       /* ë“œë¡­ë‹¤ìš´ ì˜µì…˜ë“¤ì˜ ìœ„ì¹˜ ê¸°ì¤€ì  */
        display: inline-block;    /* ë‹¤ë¥¸ ìš”ì†Œë“¤ê³¼ ê°™ì€ ì¤„ì— ë°°ì¹˜ë˜ë„ë¡ */
    }

    .search-type-button {
        background-color: #f8f8f8; /* ë²„íŠ¼ ë°°ê²½ìƒ‰ */
        color: #333;               /* ë²„íŠ¼ ê¸€ììƒ‰ */
        padding: 0 12px;          /* ë²„íŠ¼ ë‚´ë¶€ ì¢Œìš° íŒ¨ë”© */
        border: 1px solid #ccc;   /* í…Œë‘ë¦¬ */
        border-right: none;       /* ì˜¤ë¥¸ìª½ í…Œë‘ë¦¬ëŠ” ì…ë ¥ì°½ê³¼ ì—°ê²°ë˜ë¯€ë¡œ ì œê±° */
        border-radius: 15px 0 0 15px; /* ì™¼ìª½ ëª¨ì„œë¦¬ë§Œ ë‘¥ê¸€ê²Œ */
        cursor: pointer;
        font-size: 14px;
        height: 40px;             /* ì…ë ¥ì°½, ê²€ìƒ‰ ë²„íŠ¼ê³¼ ë†’ì´ í†µì¼ */
        box-sizing: border-box;   /* íŒ¨ë”©, í…Œë‘ë¦¬ê°€ ë†’ì´ì— í¬í•¨ë˜ë„ë¡ */
        display: flex;            /* ë‚´ë¶€ í…ìŠ¤íŠ¸ì™€ í™”ì‚´í‘œ ì•„ì´ì½˜ ì •ë ¬ìš© */
        align-items: center;      /* ë‚´ë¶€ ìš”ì†Œë“¤ ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
        min-width: 100px;         /* ë²„íŠ¼ì˜ ìµœì†Œ ë„ˆë¹„ */
        justify-content: space-between; /* í…ìŠ¤íŠ¸ì™€ í™”ì‚´í‘œ ì‚¬ì´ì— ê³µê°„ ë¶„ë°° */
    }

    .search-type-button .arrow {
        margin-left: 8px;         /* í…ìŠ¤íŠ¸ì™€ í™”ì‚´í‘œ ì‚¬ì´ ê°„ê²© */
        font-size: 0.7em;         /* í™”ì‚´í‘œ í¬ê¸° */
        transition: transform 0.2s ease-in-out; /* ë¶€ë“œëŸ¬ìš´ íšŒì „ íš¨ê³¼ */
    }
    .search-type-button.open .arrow { /* JavaScriptë¡œ 'open' í´ë˜ìŠ¤ ì¶”ê°€ ì‹œ í™”ì‚´í‘œ íšŒì „ */
        transform: rotate(180deg);
    }

    .search-type-options {
        display: none;            /* í‰ì†Œì—ëŠ” ìˆ¨ê²¨ë‘  (JavaScriptë¡œ block/none í† ê¸€) */
        position: absolute;       /* ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ ì•„ë˜ì— ì ˆëŒ€ ìœ„ì¹˜ë¡œ ë°°ì¹˜ */
        background-color: white;
        min-width: 120px;         /* ë²„íŠ¼ë³´ë‹¤ ì•½ê°„ ë„“ê²Œ */
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1); /* ê·¸ë¦¼ì íš¨ê³¼ */
        z-index: 1001;            /* ë‹¤ë¥¸ ìš”ì†Œë“¤ (ì˜ˆ: sticky_category_nav) ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ */
        border: 1px solid #ddd;
        border-top: none;         /* ë²„íŠ¼ê³¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ ìœ„ìª½ í…Œë‘ë¦¬ ì œê±° */
        border-radius: 0 0 4px 4px; /* ì•„ë˜ìª½ ëª¨ì„œë¦¬ë§Œ ì‚´ì§ ë‘¥ê¸€ê²Œ */
        left: 0;                  /* ë¶€ëª¨(.search-type-dropdown)ì˜ ì™¼ìª½ì— ë§ì¶¤ */
        top: 100%;                /* ë²„íŠ¼ ë°”ë¡œ ì•„ë˜ì— í‘œì‹œ */
    }

    .search-type-options a {
        color: black;
        padding: 10px 12px;
        text-decoration: none;
        display: block;           /* ê° ì˜µì…˜ì´ í•œ ì¤„ ì „ì²´ë¥¼ ì°¨ì§€í•˜ì—¬ í´ë¦­ ìš©ì´í•˜ê²Œ */
        font-size: 14px;
        white-space: nowrap;      /* ì˜µì…˜ í…ìŠ¤íŠ¸ê°€ ê¸¸ì–´ë„ ì¤„ë°”ê¿ˆë˜ì§€ ì•Šë„ë¡ */
    }

    .search-type-options a:hover {
        background-color: #f1f1f1;
    }

    /* ê¸°ì¡´ ê²€ìƒ‰ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
    .search-bar input[type="text"] {
        width: 300px;             /* ê¸°ì¡´ ë„ˆë¹„ ìœ ì§€ ë˜ëŠ” í•„ìš”ì‹œ ì¡°ì ˆ */
        padding: 10px;
        border-radius: 0;         /* ì¤‘ìš”: ë“œë¡­ë‹¤ìš´ê³¼ ì´ì–´ì§€ë¯€ë¡œ ì™¼ìª½ ë‘¥ê·¼ ëª¨ì„œë¦¬ ì œê±° */
        border: 1px solid #ccc;
        border-left: none;        /* ì¤‘ìš”: ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ê³¼ í…Œë‘ë¦¬ê°€ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì™¼ìª½ í…Œë‘ë¦¬ ì œê±° */
        border-right: none;       /* ì¤‘ìš”: ê²€ìƒ‰ ë²„íŠ¼ê³¼ í…Œë‘ë¦¬ê°€ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì˜¤ë¥¸ìª½ í…Œë‘ë¦¬ ì œê±° */
        height: 40px;             /* ë“œë¡­ë‹¤ìš´ ë²„íŠ¼, ê²€ìƒ‰ ë²„íŠ¼ê³¼ ë†’ì´ í†µì¼ */
        box-sizing: border-box;
        font-size: 14px;
    }

    /* ê¸°ì¡´ ê²€ìƒ‰ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
    .search-bar button[type="submit"] { /* ë‹ë³´ê¸° ë²„íŠ¼ */
        padding: 10px 15px;
        border: 1px solid #ccc;
        background-color: #eee;
        border-radius: 0 15px 15px 0; /* ì˜¤ë¥¸ìª½ ëª¨ì„œë¦¬ë§Œ ë‘¥ê¸€ê²Œ */
        cursor: pointer;
        height: 40px;             /* ë“œë¡­ë‹¤ìš´ ë²„íŠ¼, ì…ë ¥ì°½ê³¼ ë†’ì´ í†µì¼ */
        box-sizing: border-box;
        font-size: 16px;          /* ë‹ë³´ê¸° ì•„ì´ì½˜ í¬ê¸° */
    }
    /* === END ê²€ìƒ‰ì°½ ë° ë“œë¡­ë‹¤ìš´ CSS === */

    /* --- ë‚˜ë¨¸ì§€ ê¸°ì¡´ ìŠ¤íƒ€ì¼ (.search-results-title-container, .book-grid ë“±)ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ --- */
    .search-results-title-container { 
        text-align: center; margin-bottom: 25px; margin-top: 20px;
    }
    .search-results-title-container h2 {
        font-size: 1.8em; color: #2C1B13; margin-top: 0; margin-bottom: 0; font-weight: bold;
    }
    .search-results-title-container h2 span.search-count {
        font-size: 1.0em; color: #555; margin-left: 8px; font-weight: bold;
    }
    .book-grid { 
        display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-bottom: 40px;
    }
    .book-card { 
        background-color: #fff; padding: 15px; border-radius: 10px; text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column;
        justify-content: space-between; width: 100%; max-width: 200px; min-height: 280px; 
    }
    .book-card img { 
        width: 100%; max-height: 180px; object-fit: contain; border-radius: 5px; margin-bottom: 10px;
    }
    .book-card p { 
        font-size: 0.9em; color: #333; margin-bottom: 10px; height: 3.2em; line-height: 1.6em; 
        overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; 
        -webkit-box-orient: vertical;
    }
    .book-card .detail-link { 
        font-size: 0.8em; color: #A67C52; text-decoration: none; font-weight: bold;
        padding: 5px 0; margin-top: auto; 
    }
    .no-results { 
        width: 100%; text-align: center; margin-top: 20px; padding: 40px 20px; 
        font-size: 1.2em; color: #777;       
    }
    .custom-pagination { text-align: center; margin: 30px auto; }
    .custom-pagination a, .custom-pagination .current {
        padding: 8px 12px; margin: 0 3px; text-decoration: none; color: #333;
        border: 1px solid #ddd; border-radius: 4px;
    }
    .custom-pagination .current {
        font-weight: bold; background-color: #D2B9AD; color: #2C1B13; border-color: #D2B9AD;
    }
    .custom-pagination a:hover { background-color: #eee; }
    .custom-pagination .disabled {
        color: #ccc; pointer-events: none; cursor: default; 
        padding: 8px 12px; margin: 0 2px; border: 1px solid #ddd; border-radius: 4px;
    }
</style>

<div class="category-page-content-wrapper">
    <div class="category-sections-wrapper section"> {# ë°°ê²½ìƒ‰ ë“±ì„ ìœ„í•´ .section í´ë˜ìŠ¤ ì¶”ê°€ ê°€ëŠ¥ #}

        <div class="search-results-title-container"> {# ë³€ê²½ëœ ì œëª© ì»¨í…Œì´ë„ˆ #}
            <h2>
                {{ page_title }} {# ë·°ì—ì„œ ì „ë‹¬ëœ page_title (ì˜ˆ: "'ê²€ìƒ‰ì–´' ê²€ìƒ‰ ê²°ê³¼ (ì¹´í…Œê³ ë¦¬ëª…)") #}
                {% if query %}<span class="search-count">({{ page_obj.paginator.count }}ê±´)</span>{% endif %}
            </h2>
        </div>

        <div class="search-bar">
            {# HTML êµ¬ì¡°ëŠ” ì´ì „ ë‹µë³€ì—ì„œ ì œê³µí•œ ê²ƒì´ë©°, ì‚¬ìš©ì ì½”ë“œì—ë„ ì´ë¯¸ ë°˜ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤. #}
            {# formì˜ action ê°’ì€ ê° í…œí”Œë¦¿ì— ë§ê²Œ ì„¤ì •í•©ë‹ˆë‹¤. #}
            {# category.htmlì˜ ê²½ìš° request.path, category_total.htmlì˜ ê²½ìš° {% url 'books:all_books_list' %} #}
            <form id="pageSearchForm" method="GET" action="{{ request.path }}" style="display: flex;">
                <div class="search-type-dropdown">
                    <button type="button" id="searchTypeButton" class="search-type-button">
                        <span id="selectedSearchType">
                            {% if search_type == 'title' %}ì œëª©
                            {% elif search_type == 'author' %}ì‘ê°€
                            {% elif search_type == 'publisher' %}ì¶œíŒì‚¬
                            {% elif search_type == 'integrated' %}í†µí•©ê²€ìƒ‰
                            {% else %}í†µí•©ê²€ìƒ‰
                            {% endif %}
                        </span>
                        <span class="arrow">â–¼</span>
                    </button>
                    <div id="searchTypeOptions" class="search-type-options">
                        <a href="#" data-value="integrated" data-text="í†µí•©ê²€ìƒ‰">í†µí•©ê²€ìƒ‰</a>
                        <a href="#" data-value="title" data-text="ì œëª©">ì œëª©</a>
                        <a href="#" data-value="author" data-text="ì‘ê°€">ì‘ê°€</a>
                        <a href="#" data-value="publisher" data-text="ì¶œíŒì‚¬">ì¶œíŒì‚¬</a>
                    </div>
                </div>
                <input type="hidden" name="search_type" id="searchTypeInput" value="{{ search_type|default:'integrated' }}">
                {% if current_category_object or current_group_slug %}
                    <input type="text" name="q" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”." value="{{ query|default:'' }}">
                {% else %} {# category_total.htmlì˜ ê²½ìš° #}
                    <input type="text" name="q" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”." value="{{ query|default:'' }}">
                {% endif %}
                <button type="submit">ğŸ”</button>
            </form>
        </div>

        {% if page_obj and page_obj.object_list %}
            <div class="book-grid">
                {% for book in page_obj %}
                <div class="book-card">
                    <a href="{% url 'books:book_detail' book_id=book.id %}">
                        <img src="{{ book.cover_image_url|default:'https://placehold.co/150x180/e2e8f0/a0aec0?text=No+Image' }}" alt="{{ book.title }}">
                    </a>
                    <p>{{ book.title }}</p>
                    <a href="{% url 'books:book_detail' book_id=book.id %}" class="detail-link">ìì„¸íˆ ë³´ê¸°</a>
                </div>
                {% endfor %}
            </div>

            {% if is_paginated and page_obj.paginator.num_pages > 1 %}
            <div class="custom-pagination">
                {% if first_page_jump_target %}
                <a href="?page={{ first_page_jump_target }}{% if query %}&q={{ query }}&search_type={{ search_type }}{% endif %}" aria-label="First Page">&laquo;&laquo;</a>
                {% else %}
                <span class="disabled" aria-hidden="true">&laquo;&laquo;</span>
                {% endif %}
                {% if prev_single_page_target %}
                <a href="?page={{ prev_single_page_target }}{% if query %}&q={{ query }}&search_type={{ search_type }}{% endif %}" aria-label="Previous Page">&laquo;</a>
                {% else %}
                <span class="disabled" aria-hidden="true">&laquo;</span>
                {% endif %}
                {% for page_num in visible_page_numbers %}
                {% if page_obj.number == page_num %}
                <span class="current">{{ page_num }}</span>
                {% else %}
                <a href="?page={{ page_num }}{% if query %}&q={{ query }}&search_type={{ search_type }}{% endif %}">{{ page_num }}</a>
                {% endif %}
                {% endfor %}
                {% if next_single_page_target %}
                <a href="?page={{ next_single_page_target }}{% if query %}&q={{ query }}&search_type={{ search_type }}{% endif %}" aria-label="Next Page">&raquo;</a>
                {% else %}
                <span class="disabled" aria-hidden="true">&raquo;</span>
                {% endif %}
                {% if last_page_jump_target %}
                <a href="?page={{ last_page_jump_target }}{% if query %}&q={{ query }}&search_type={{ search_type }}{% endif %}" aria-label="Last Page">&raquo;&raquo;</a>
                {% else %}
                <span class="disabled" aria-hidden="true">&raquo;&raquo;</span>
                {% endif %}
            </div>
            {% endif %}
        {% else %}
            <p class="no-results">
                {% if query %}
                '{{ query }}'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                {% else %}
                ì´ ì¹´í…Œê³ ë¦¬ì—ëŠ” ì•„ì§ ë“±ë¡ëœ ì±…ì´ ì—†ìŠµë‹ˆë‹¤.
                {% endif %}
            </p>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const searchTypeButton = document.getElementById('searchTypeButton'); 
    const searchTypeOptions = document.getElementById('searchTypeOptions');
    const selectedSearchTypeSpan = document.getElementById('selectedSearchType');
    const searchTypeInput = document.getElementById('searchTypeInput');

    if (searchTypeButton && searchTypeOptions && selectedSearchTypeSpan && searchTypeInput) {
        searchTypeButton.addEventListener('click', function(event) {
            event.stopPropagation(); 
            const isOpen = searchTypeOptions.style.display === 'block';
            searchTypeOptions.style.display = isOpen ? 'none' : 'block';
            searchTypeButton.classList.toggle('open', !isOpen);
        });

        searchTypeOptions.querySelectorAll('a').forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                selectedSearchTypeSpan.textContent = this.dataset.text;
                searchTypeInput.value = this.dataset.value;
                searchTypeOptions.style.display = 'none';
                searchTypeButton.classList.remove('open');
            });
        });

        document.addEventListener('click', function(event) {
            // Ensure elements exist before accessing style or contains property
            if (searchTypeOptions && searchTypeOptions.style.display === 'block' && 
                searchTypeButton && !searchTypeButton.contains(event.target) && 
                !searchTypeOptions.contains(event.target)) {
                searchTypeOptions.style.display = 'none';
                if (searchTypeButton) searchTypeButton.classList.remove('open');
            }
        });
    }
});
</script>
{% endblock %}